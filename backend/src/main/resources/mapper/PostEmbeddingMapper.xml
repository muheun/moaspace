<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="me.muheun.moaspace.mapper.PostEmbeddingMapper">

    <!-- 벡터 유사도 검색 (pgvector <=> 연산자) -->
    <select id="findSimilarPosts" resultType="me.muheun.moaspace.query.dto.PostSimilarity">
        SELECT
            p.id AS postId,
            p.title AS title,
            1 - (pe.embedding &lt;=&gt; CAST(#{queryVector} AS vector)) AS similarity
        FROM post_embeddings pe
        INNER JOIN posts p ON pe.post_id = p.id
        WHERE p.deleted = false
          AND 1 - (pe.embedding &lt;=&gt; CAST(#{queryVector} AS vector)) &gt;= #{threshold}
        ORDER BY pe.embedding &lt;=&gt; CAST(#{queryVector} AS vector) ASC
        LIMIT #{limit}
    </select>

</mapper>
