<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- VectorChunk MyBatis Mapper -->
<mapper namespace="me.muheun.moaspace.mapper.VectorChunkMapper">

    <!-- 레코드별 유사도 검색 -->
    <select id="findSimilarRecords" resultType="me.muheun.moaspace.query.dto.RecordSimilarityScore">
        SELECT
            v.record_key as recordKey,
            MAX(1 - (v.chunk_vector &lt;=&gt; CAST(#{queryVector} AS vector))) as score
        FROM vector_chunks v
        WHERE v.chunk_vector IS NOT NULL
        <if test="namespace != null">
            AND v.namespace = #{namespace}
        </if>
        <if test="entity != null">
            AND v.entity = #{entity}
        </if>
        GROUP BY v.record_key
        ORDER BY score DESC
        LIMIT #{limit}
    </select>

    <!-- 청크 상세 정보 검색 -->
    <select id="findTopChunksByRecord" resultType="me.muheun.moaspace.query.dto.ChunkDetail">
        WITH ranked_chunks AS (
            SELECT
                v.id,
                v.namespace,
                v.entity,
                v.record_key,
                v.field_name,
                1 - (v.chunk_vector &lt;=&gt; CAST(#{queryVector} AS vector)) as score,
                ROW_NUMBER() OVER (
                    PARTITION BY v.namespace, v.entity, v.record_key
                    ORDER BY (1 - (v.chunk_vector &lt;=&gt; CAST(#{queryVector} AS vector))) DESC
                ) as rank
            FROM vector_chunks v
            WHERE v.chunk_vector IS NOT NULL
            <if test="namespace != null">
                AND v.namespace = #{namespace}
            </if>
            <if test="entity != null">
                AND v.entity = #{entity}
            </if>
            <if test="fieldName != null">
                AND v.field_name = #{fieldName}
            </if>
        )
        SELECT
            id as chunkId,
            namespace,
            entity,
            record_key as recordKey,
            field_name as fieldName,
            score
        FROM ranked_chunks
        WHERE rank = 1
        ORDER BY score DESC
        LIMIT #{limit}
    </select>

    <!-- 필드별 가중치 적용 검색 (T003: Phase 1 개선) -->
    <!-- Constitution Principle II, III: 필드별 가중치 및 임계값 필터링 -->
    <!-- SC-003: title weight=3.0 → content 대비 최소 2배 이상 높은 스코어 -->
    <!-- SC-006: threshold=0.7 → 0.65 제외 (임계값 경계 테스트) -->
    <select id="findByWeightedFieldScore" resultType="me.muheun.moaspace.query.dto.WeightedScore">
        WITH field_scores AS (
            -- Step 1: 각 레코드의 필드별 최고 스코어 계산
            SELECT
                v.record_key,
                v.field_name,
                MAX(1 - (v.chunk_vector &lt;=&gt; CAST(#{queryVector} AS vector))) AS field_max_score
            FROM vector_chunks v
            WHERE v.chunk_vector IS NOT NULL
            <if test="namespace != null">
                AND v.namespace = #{namespace}
            </if>
            <if test="entity != null">
                AND v.entity = #{entity}
            </if>
            GROUP BY v.record_key, v.field_name
        ),
        weighted_scores AS (
            -- Step 2: 파라미터 가중치 적용 (titleWeight, contentWeight)
            SELECT
                fs.record_key,
                fs.field_name,
                (fs.field_max_score *
                    CASE
                        WHEN fs.field_name = 'title' THEN #{titleWeight}
                        WHEN fs.field_name = 'content' THEN #{contentWeight}
                        ELSE 1.0
                    END
                ) AS weighted_score
            FROM field_scores fs
        )
        -- Step 3: 필드별 가중치 스코어 반환
        SELECT
            ws.record_key AS recordKey,
            ws.field_name AS fieldName,
            ws.weighted_score AS weightedScore
        FROM weighted_scores ws
        ORDER BY ws.record_key, ws.weighted_score DESC
        LIMIT #{limit}
    </select>

    <!-- 필터 기반 삭제 -->
    <delete id="deleteByFilters">
        DELETE FROM vector_chunks
        WHERE namespace = #{namespace}
          AND entity = #{entity}
          AND record_key = #{recordKey}
        <if test="fieldName != null">
          AND field_name = #{fieldName}
        </if>
    </delete>

</mapper>
