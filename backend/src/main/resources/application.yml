spring:
  application:
    name: moaspace

  datasource:
    url: ${DB_JDBC_URL}
    username: ${DB_USER}
    password: ${DB_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      pool-name: HikariCP-Vector

  # Flyway 데이터베이스 마이그레이션 설정
  flyway:
    enabled: true
    baseline-on-migrate: true  # 기존 DB에 Flyway 적용 시 베이스라인 자동 생성
    baseline-version: 1  # 베이스라인 버전 (V1__initial_schema.sql)
    locations: classpath:db/migration  # 마이그레이션 스크립트 위치
    validate-on-migrate: true  # 마이그레이션 전 검증 활성화
    out-of-order: false  # 순서대로 마이그레이션 강제
    placeholder-replacement: false  # 플레이스홀더 치환 비활성화

  # Spring Cache 설정 (Phase 1 - VectorConfig 캐싱)
  cache:
    type: simple  # in-memory 캐시 (Phase 2+: redis)
    cache-names: vectorConfig

  jpa:
    hibernate:
      ddl-auto: validate  # Flyway가 스키마 관리, JPA는 검증만 수행
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        # Batch Insert 설정 (성능 향상)
        jdbc:
          batch_size: 50
          time_zone: UTC  # 타임스탬프 UTC 처리
        order_inserts: true
        order_updates: true
    open-in-view: false

  # Google OAuth2 설정 (T018)
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: ${GOOGLE_CLIENT_ID}
            client-secret: ${GOOGLE_CLIENT_SECRET}
            scope:
              - email
              - profile
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
            authorization-grant-type: authorization_code

server:
  port: 8080

logging:
  level:
    root: INFO
    me.muheun.moaspace: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{requestId}] %-5level %logger{36} - %msg%n"

# JWT 설정 (T019)
jwt:
  secret: ${JWT_SECRET}
  access-token-expiration: 3600000  # 1시간 (밀리초)
  refresh-token-expiration: 604800000  # 7일 (밀리초)

# Frontend URL 설정 (OAuth2 리다이렉트용)
frontend:
  url: ${FRONTEND_URL:http://localhost:3000}

# 벡터 임베딩 설정 (DJL 기반 ONNX 모델)
vector:
  embedding:
    provider: onnx  # 임베딩 제공자 (onnx, openai, mock 등)
    model-path: ${ONNX_MODEL_PATH}  # ONNX 모델 파일 경로 (환경변수)
    tokenizer-path: ${ONNX_TOKENIZER_PATH}  # HuggingFace Tokenizer 파일 경로 (환경변수)
    dimension: 768  # MPNet-base-v2 벡터 차원 (MiniLM에서 전환)
    max-tokens: 512  # 최대 토큰 길이 (truncate)

  # 벡터 인덱싱 설정 (중앙화된 설정)
  indexing:
    # 청킹 설정
    chunking:
      max-tokens-per-chunk: 200  # 청크당 최대 토큰 수
      target-tokens-per-chunk: 150  # 청크당 목표 토큰 수
      overlap-tokens: 50  # 청크 간 오버랩 토큰 수

    # 엔티티별 필드 가중치
    field-weights:
      posts:
        weights:
          title: 0.6  # 제목 가중치 60%
          content: 0.4  # 본문 가중치 40%

    # 기본 설정값
    defaults:
      namespace: vector_ai  # 기본 네임스페이스
      search-limit: 10  # 검색 시 기본 limit
